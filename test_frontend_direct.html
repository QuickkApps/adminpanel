<!DOCTYPE html>
<html>
<head>
    <title>Test Frontend Direct</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Test Frontend Direct</h1>
    <div id="debug-output"></div>
    <div id="fallbackUrlsList" style="border: 1px solid #ccc; padding: 20px; margin: 20px 0;">
        <div id="fallbackUrlsLoading">Loading...</div>
    </div>
    <button onclick="testDirectly()">Test Directly</button>
    
    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('debug-output');
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.innerHTML = new Date().toLocaleTimeString() + ': ' + message;
            output.appendChild(div);
            console.log(message);
        }
        
        // Copy the exact functions from the main app
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('adminToken');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                }
            };
            
            const response = await fetch(`http://localhost:3003${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Copy the exact displayFallbackUrls function
        function displayFallbackUrls(urls) {
            log(`üìã displayFallbackUrls called with ${urls.length} URLs`);
            const urlsList = document.getElementById('fallbackUrlsList');
            if (!urlsList) {
                log('‚ùå fallbackUrlsList element not found', 'error');
                return;
            }
            
            log(`üìã URLs array: ${JSON.stringify(urls)}`);
            
            if (urls.length === 0) {
                log('üìã No URLs, showing empty message');
                urlsList.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <i class="fas fa-route" style="margin-right: 8px;"></i>
                        No fallback URLs configured
                    </div>
                `;
                return;
            }
            
            log(`üìã Displaying ${urls.length} URLs`);
            urlsList.innerHTML = `
                <div class="fallback-urls-container">
                    ${urls.map(url => `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                            <strong>${escapeHtml(url.url)}</strong><br>
                            Type: ${url.url_type}<br>
                            Active: ${url.is_active ? 'Yes' : 'No'}<br>
                            Priority: ${url.priority}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Copy the exact refreshFallbackUrls function
        async function refreshFallbackUrls() {
            log('üîÑ Refreshing fallback URLs...');
            const urlsList = document.getElementById('fallbackUrlsList');
            const loading = document.getElementById('fallbackUrlsLoading');
            
            if (loading) {
                loading.style.display = 'block';
            }
            
            try {
                log('üì° Making API call to /api/fallback-urls');
                const response = await apiCall('/api/fallback-urls');
                log(`üì° API response: ${JSON.stringify(response)}`);
                
                const fallbackUrls = response.data || [];
                log(`üìã Extracted ${fallbackUrls.length} URLs from response`);
                
                displayFallbackUrls(fallbackUrls);
                
                if (loading) {
                    loading.style.display = 'none';
                }
                
                log(`‚úÖ Loaded ${fallbackUrls.length} fallback URLs`, 'success');
            } catch (error) {
                log(`‚ùå Error loading fallback URLs: ${error.message}`, 'error');
                if (urlsList) {
                    urlsList.innerHTML = `
                        <div style="text-align: center; color: red; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                            Error loading fallback URLs: ${error.message}
                        </div>
                    `;
                }
                if (loading) {
                    loading.style.display = 'none';
                }
            }
        }
        
        async function login() {
            try {
                log('üîê Logging in...');
                const response = await fetch('http://localhost:3003/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('adminToken', data.token);
                    log('‚úÖ Login successful', 'success');
                    return true;
                } else {
                    log(`‚ùå Login failed: ${data.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Login error: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testDirectly() {
            const output = document.getElementById('debug-output');
            output.innerHTML = '';
            
            log('üöÄ Starting direct test...');
            
            // Login first
            const loginSuccess = await login();
            if (!loginSuccess) {
                log('‚ùå Cannot continue without login', 'error');
                return;
            }
            
            // Test the refresh function
            await refreshFallbackUrls();
            
            log('‚úÖ Direct test completed', 'success');
        }
        
        // Auto-run test on page load
        window.addEventListener('load', () => {
            setTimeout(testDirectly, 1000);
        });
    </script>
</body>
</html>
